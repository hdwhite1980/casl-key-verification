<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASL Key Verification System</title>
    
    <!-- Load configuration first -->
    <script src="casl-config.js"></script>
    
    <!-- Load all supporting JS files in order -->
    <script src="constants.js"></script>
    <script src="storage.js"></script>
    <script src="validation.js"></script>
    <script src="api.js"></script>
    <script src="userService.js"></script>
    <script src="paymentService.js"></script>
    <script src="i18n.js"></script>
    <script src="styles.js"></script>
    <script src="ConfigManager.js"></script>
    <script src="ErrorHandler.js"></script>
    <script src="StateManager.js"></script>
    <script src="EventManager.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8f9fa; 
        }
        
        .loading-screen { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .loading-spinner { 
            width: 50px; 
            height: 50px; 
            border: 4px solid rgba(255,255,255,0.3); 
            border-top: 4px solid white; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-bottom: 1.5rem;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .loading-text {
            font-size: 1.2rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }
        
        .loading-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .error-screen { 
            padding: 3rem 2rem; 
            text-align: center; 
            background: #fff;
            margin: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .error-title {
            color: #dc3545;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .error-message {
            color: #6c757d;
            margin-bottom: 2rem;
            line-height: 1.5;
        }
        
        .error-details {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: #495057;
            text-align: left;
            border-left: 4px solid #dc3545;
        }
        
        .retry-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .app-container {
            min-height: 100vh;
        }
        
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: monospace;
            max-width: 300px;
            z-index: 1000;
        }
        
        @media (max-width: 768px) {
            .loading-screen {
                padding: 2rem;
            }
            
            .error-screen {
                margin: 1rem;
                padding: 2rem 1rem;
            }
            
            .debug-info {
                position: relative;
                bottom: auto;
                right: auto;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">CASL Key Verification</div>
        <div class="loading-subtext">Initializing secure verification system...</div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="app-container" style="display: none;">
        <casl-app></casl-app>
    </div>
    
    <!-- Error Screen -->
    <div id="error-screen" class="error-screen" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Application Failed to Load</div>
        <div class="error-message" id="error-message">
            We're having trouble starting the application. Please try refreshing the page.
        </div>
        <div class="error-details" id="error-details" style="display: none;"></div>
        <button class="retry-button" onclick="location.reload()">
            üîÑ Retry
        </button>
    </div>
    
    <!-- Debug Info (remove in production) -->
    <div id="debug-info" class="debug-info" style="display: none;"></div>

    <script>
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global Error:', event.error);
            showError('JavaScript Error: ' + event.error.message, event.error.stack);
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Promise Rejection:', event.reason);
            showError('Promise Error: ' + event.reason, event.reason);
        });
        
        // Debug logging
        function debugLog(message) {
            console.log('üîß CASL Debug:', message);
            const debugDiv = document.getElementById('debug-info');
            if (debugDiv) {
                debugDiv.textContent = message;
                debugDiv.style.display = 'block';
                setTimeout(() => {
                    debugDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        function showError(message, details = null) {
            console.error('‚ùå CASL Error:', message);
            
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('error-screen').style.display = 'block';
            
            document.getElementById('error-message').textContent = message;
            
            if (details) {
                const detailsDiv = document.getElementById('error-details');
                detailsDiv.textContent = details;
                detailsDiv.style.display = 'block';
            }
        }
        
        function showApp() {
            debugLog('‚úÖ Showing application');
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }
        
        // Initialization function
        async function initializeApp() {
            try {
                debugLog('üöÄ Starting CASL initialization...');
                
                // Step 1: Check if configuration is loaded
                debugLog('üìã Checking configuration...');
                if (!window.CASL_CONFIG) {
                    throw new Error('CASL configuration not loaded. Please check casl-config.js file.');
                }
                console.log('‚úÖ Configuration loaded:', window.CASL_CONFIG);
                
                // Step 2: Wait a moment for all scripts to load
                debugLog('‚è≥ Waiting for dependencies...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 3: Load the main CASLApp component
                debugLog('üì¶ Loading CASL App component...');
                const script = document.createElement('script');
                script.src = 'CASLApp.js';
                
                script.onload = function() {
                    debugLog('‚úÖ CASLApp.js loaded successfully');
                    
                    // Give the custom element time to register
                    setTimeout(() => {
                        // Check if the custom element is defined
                        if (customElements.get('casl-app')) {
                            debugLog('‚úÖ Custom element registered');
                            showApp();
                            console.log('üéâ CASL Key Verification System loaded successfully!');
                        } else {
                            debugLog('‚è≥ Waiting for custom element registration...');
                            // Wait a bit more and try again
                            setTimeout(() => {
                                if (customElements.get('casl-app')) {
                                    showApp();
                                    console.log('üéâ CASL Key Verification System loaded successfully!');
                                } else {
                                    throw new Error('Custom element <casl-app> failed to register');
                                }
                            }, 1000);
                        }
                    }, 100);
                };
                
                script.onerror = function(event) {
                    throw new Error('Failed to load CASLApp.js. Please check if the file exists and is accessible.');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showError(error.message, error.stack);
            }
        }
        
        // Enhanced ready state handler
        function startWhenReady() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initializeApp, 100);
                });
            } else {
                setTimeout(initializeApp, 100);
            }
        }
        
        // Start the initialization
        startWhenReady();
        
        // Fallback timeout
        setTimeout(function() {
            if (document.getElementById('loading-screen').style.display !== 'none') {
                console.warn('‚ö†Ô∏è App initialization took too long, something may be wrong');
                showError(
                    'The application is taking longer than expected to load.',
                    'This might indicate a problem with the JavaScript files or network connection.'
                );
            }
        }, 15000); // 15 second timeout
    </script>
</body>
</html>
